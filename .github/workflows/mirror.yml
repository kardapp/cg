name: Mirror upstream

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

env:
  UPSTREAM_OWNER: Clinical-Genomics
  UPSTREAM_REPO: cg
  TARGET_OWNER: kardapp
  TARGET_REPO: cg

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fetch upstream
        run: |
          git remote add upstream https://github.com/${UPSTREAM_OWNER}/${UPSTREAM_REPO}.git
          git fetch upstream --prune --tags
      - name: Push mirror
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${TARGET_OWNER}/${TARGET_REPO}.git
          git push origin --mirror

  sync-releases:
    needs: mirror
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ github.token }}
      UPSTREAM_OWNER: Clinical-Genomics
      UPSTREAM_REPO: cg
      TARGET_OWNER: kardapp
      TARGET_REPO: cg
    steps:
      - name: Copy releases from upstream
        run: |
          set -euo pipefail
          gh api repos/${UPSTREAM_OWNER}/${UPSTREAM_REPO}/releases --paginate |
          jq -c '.[]' | while read rel; do
            tag=$(echo "$rel" | jq -r '.tag_name')
            name=$(echo "$rel" | jq -r '.name')
            body=$(echo "$rel" | jq -r '.body // ""')
            draft=$(echo "$rel" | jq -r '.draft')
            prerelease=$(echo "$rel" | jq -r '.prerelease')
            existing=$(gh api repos/${TARGET_OWNER}/${TARGET_REPO}/releases/tags/$tag 2>/dev/null || true)
            if [ -n "$existing" ]; then
              id=$(echo "$existing" | jq -r '.id')
              gh api repos/${TARGET_OWNER}/${TARGET_REPO}/releases/$id \
                -X PATCH -f tag_name="$tag" -f name="$name" -f body="$body" \
                -F draft="$draft" -F prerelease="$prerelease"
            else
              gh api repos/${TARGET_OWNER}/${TARGET_REPO}/releases \
                -X POST -f tag_name="$tag" -f name="$name" -f body="$body" \
                -F draft="$draft" -F prerelease="$prerelease"
            fi
          done
